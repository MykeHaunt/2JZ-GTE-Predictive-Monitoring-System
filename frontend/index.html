<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>2JZ-GTE Live Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="day-theme">

  <h1>2JZ-GTE Predictive Monitoring Dashboard</h1>

  <div class="metrics-grid">
    <div class="metric-card"><div>RPM</div><div id="rpm">--</div></div>
    <div class="metric-card"><div>Boost</div><div id="boost">--</div></div>
    <div class="metric-card"><div>AFR</div><div id="afr">--</div></div>
    <div class="metric-card"><div>Coolant</div><div id="coolant">--</div></div>
    <div class="metric-card"><div>Knock</div><div id="knock">--</div></div>
  </div>

  <h2>Live Auto-Calculated Metrics</h2>
  <div class="metrics-grid">
    <div class="metric-card"><div>AFR Δ</div><div id="afr-delta">--</div></div>
    <div class="metric-card"><div>Coolant Rise (°C/s)</div><div id="coolant-rate">--</div></div>
    <div class="metric-card"><div>Turbo Response</div><div id="turbo-response">--</div></div>
  </div>

  <div id="live-update-indicator">Streaming @ ~23.6Hz</div>

  <script>
    const metrics = {
      afr: [],
      coolant: [],
      rpm: [],
      boost: [],
      timestamps: []
    };

    function updateMetricHistory(key, value) {
      if (!metrics[key]) metrics[key] = [];
      metrics[key].push(value);
      if (metrics[key].length > 30) metrics[key].shift();
    }

    function calculateMetrics() {
      const len = metrics.timestamps.length;
      if (len < 2) return;

      const afrDelta = metrics.afr[len-1] - metrics.afr[len-2];
      const coolantRate = (metrics.coolant[len-1] - metrics.coolant[len-2]) /
                          (metrics.timestamps[len-1] - metrics.timestamps[len-2]);
      const rpmDelta = metrics.rpm[len-1] - metrics.rpm[len-2];
      const boostDelta = metrics.boost[len-1] - metrics.boost[len-2];
      const turboResponse = rpmDelta !== 0 ? (boostDelta / rpmDelta) : 0;

      document.getElementById("afr-delta").innerText = afrDelta.toFixed(3);
      document.getElementById("coolant-rate").innerText = coolantRate.toFixed(4);
      document.getElementById("turbo-response").innerText = turboResponse.toFixed(5);
    }

    const socket = io("http://localhost:5050");

    socket.on("sensor_data", function(data) {
      const now = Date.now() / 1000;
      metrics.timestamps.push(now);
      updateMetricHistory("afr", data.afr);
      updateMetricHistory("coolant", data.coolant_temp);
      updateMetricHistory("rpm", data.rpm);
      updateMetricHistory("boost", data.boost);
      calculateMetrics();

      document.getElementById("rpm").innerText = data.rpm;
      document.getElementById("boost").innerText = data.boost + " bar";
      document.getElementById("afr").innerText = data.afr;
      document.getElementById("coolant").innerText = data.coolant_temp + " °C";
      document.getElementById("knock").innerText = data.knock;
    });
  </script>
</body>
</html>